<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shopping Cart</title>

</head>
<body>
  <div id="cart"></div>
<script>

const availableItems = [
  "Shampoo",
  "Soap",
  "Sponge",
  "Water",
]

function isSession() {
  try {
    const testKey = 'test';
    sessionStorage.setItem(testKey, testKey);
    sessionStorage.removeItem(testKey);
    return true;
  } catch (e) {
    return false;
  }
}

if (!isSession()) {
  alert('Sorry, your browser does not support Web storage. Try again with a better one');
} else {
  createStore();
  displayCart();
}
  function createStore() {
    const available = document.createElement("h2");
    available.textContent = 'Available products:';
    const shopList = document.createElement("ul");
    available.appendChild(shopList);
    let cart = document.getElementById("cart");
    cart.insertBefore(available, cart.firstChild);
    availableItems.forEach(item => {
      let listitem = document.createElement("li");
      listitem.textContent = item;
      listitem.addEventListener("click", () => addItemToCart(item));
      shopList.appendChild(listitem);
  });
}

function getCartFromStorage() {
  const cartitem = sessionStorage.getItem('cart');
  if (cartitem) {
    return JSON.parse(cartitem);
  } else {
    return {};
  }
}

// for task 7.   
function addItemToCart(item) {
  const cart = getCartFromStorage();
  if (cart[item]) {
      cart[item].quantity += 1;
    } else {
      cart[item] = { quantity: 1 };
    }
    sessionStorage.setItem('cart', JSON.stringify(cart));
    displayCart();
  }

function removeItemfromCart(item) {
  const cart = getCartFromStorage();
    if (cart[item] && cart[item].quantity > 0) {
      cart[item].quantity -= 1;
      if (cart[item].quantity === 0) {
        delete cart[item];
      }
      sessionStorage.setItem('cart', JSON.stringify(cart));
    }
    displayCart();
  }

  function clearCart() {
    const cart = {};
    sessionStorage.setItem('cart', JSON.stringify(cart));
    displayCart();
  }

function displayCart() {
  const cartElement = document.getElementById('cart');

  let productsHeading = cartElement.querySelector('h2');
  if (!productsHeading) {
    productsHeading = document.createElement('h2');
    productsHeading.innerText = 'Your cart:';
    cartElement.appendChild(productsHeading);
  }

  let cartDiv = cartElement.querySelector('#cartDiv');
  if (!cartDiv) {
    cartDiv = document.createElement('div');
    cartDiv.id = 'cartDiv';
    cartElement.appendChild(cartDiv);
  } else {
    cartDiv.innerHTML = '';
  }

  updateCart();
}

function updateCart() {
  const cart = getCartFromStorage();
  const cartDiv = document.getElementById('cartDiv');
  const cartSize = Object.keys(cart).length;

  if (cartSize !== 0) {
    const cartList = document.createElement('ul');

    Object.keys(cart).forEach(item => {
      const listitem = document.createElement('li');
      listitem.textContent = `${item} x ${cart[item].quantity}`;

      const removeText = document.createElement('span');
      removeText.textContent = ' (remove)';
      removeText.addEventListener('click', () => removeItemfromCart(item));
      listitem.appendChild(removeText);
      cartList.appendChild(listitem);
    });
    
    cartDiv.appendChild(cartList);
  } else {
    const emptyCart = document.createElement('p');
    emptyCart.innerText = 'Your cart is empty'
    cartDiv.appendChild(emptyCart);
  }

  const clearCart = document.createElement('p');
  clearCart.innerHTML = '<a href="#" onclick="clearCart()">Clear my cart</a>';
  cartDiv.insertBefore(clearCart, cartDiv.firstChild);
}

isSession();
</script>

</body>
</html>
